<!DOCTYPE html>
<html lang="en" class="h-full dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | TriPlan</title>
    <meta name="description" content="Track your performance metrics, training zones, and personal records for triathlon training.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        surface: {
                            50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1',
                            400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155',
                            800: '#1e293b', 900: '#0f172a', 950: '#020617'
                        },
                        sport: {
                            swim: '#0ea5e9',
                            bike: '#22c55e',
                            run: '#f97316'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .nav-glass { backdrop-filter: blur(12px); background: rgba(15, 23, 42, 0.9); }
        .card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); }
        input, select, textarea { 
            background-color: rgba(15, 23, 42, 0.6) !important; 
            border-color: rgba(51, 65, 85, 0.6) !important; 
            color: #e2e8f0 !important; 
        }
        input:focus, select:focus, textarea:focus { 
            border-color: rgba(100, 116, 139, 0.8) !important; 
            outline: none !important;
            box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.2) !important; 
        }
        .sport-swim { color: #0ea5e9; }
        .sport-bike { color: #22c55e; }
        .sport-run { color: #f97316; }
        .bg-sport-swim { background-color: rgba(14, 165, 233, 0.1); border-color: rgba(14, 165, 233, 0.25); }
        .bg-sport-bike { background-color: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.25); }
        .bg-sport-run { background-color: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.25); }
    </style>
</head>
<body class="h-full bg-surface-950 text-surface-200 antialiased">
     <div class="min-h-full flex flex-col pb-20 sm:pb-0">
        <!-- NAV_PLACEHOLDER -->
        <script>
            // Set navbar subtitle and right side content for this page
            document.addEventListener('DOMContentLoaded', function() {
                const subtitle = document.getElementById('navbarSubtitle');
                if (subtitle) subtitle.textContent = 'Athlete Profile';
                setActiveNav('profile');
            });
        </script>

        <main class="flex-1 max-w-6xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-5 space-y-5">
            <!-- Performance Metrics -->
            <div class="card rounded-xl p-5">
                <div class="flex items-center justify-between mb-5">
                    <h2 class="text-base font-semibold text-surface-100">Performance Metrics</h2>
                    <span class="text-xs text-surface-500">Update after test sessions</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <!-- FTP -->
                    <div class="bg-[#22c55e] border border-[#16a34a] rounded-xl p-5 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center text-xl">üö¥</div>
                            <div>
                                <h3 class="font-bold text-white text-sm uppercase tracking-wider">Bike FTP</h3>
                                <p class="text-white/70 text-[10px] font-medium uppercase">Threshold Power</p>
                            </div>
                        </div>
                        <div class="flex flex-col mb-4">
                            <div class="text-4xl font-black text-white leading-none tracking-tighter" id="ftpValue">212W</div>
                            <div class="text-sm text-white/80 font-semibold mt-1" id="ftpWkg">2.83 W/kg</div>
                        </div>
                        <button onclick="openTest('ftp')" class="w-full bg-white/20 hover:bg-white/30 text-white py-2.5 rounded-lg text-sm font-bold transition-all border border-white/10">
                            Log FTP Test
                        </button>
                    </div>

                    <!-- CSS -->
                    <div class="bg-[#0ea5e9] border border-[#0284c7] rounded-xl p-5 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center text-xl">üèä</div>
                            <div>
                                <h3 class="font-bold text-white text-sm uppercase tracking-wider">Swim CSS</h3>
                                <p class="text-white/70 text-[10px] font-medium uppercase">Critical Speed</p>
                            </div>
                        </div>
                        <div class="flex flex-col mb-4">
                            <div class="text-4xl font-black text-white leading-none tracking-tighter" id="cssValue">2:05</div>
                            <div class="text-sm text-white/80 font-semibold mt-1">per 100m</div>
                        </div>
                        <button onclick="openTest('css')" class="w-full bg-white/20 hover:bg-white/30 text-white py-2.5 rounded-lg text-sm font-bold transition-all border border-white/10">
                            Log CSS Test
                        </button>
                    </div>

                    <!-- Run -->
                    <div class="bg-[#f97316] border border-[#ea580c] rounded-xl p-5 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center text-xl">üèÉ</div>
                            <div>
                                <h3 class="font-bold text-white text-sm uppercase tracking-wider">Run Pace</h3>
                                <p class="text-white/70 text-[10px] font-medium uppercase">Threshold Pace</p>
                            </div>
                        </div>
                        <div class="flex flex-col mb-4">
                            <div class="text-4xl font-black text-white leading-none tracking-tighter" id="thresholdPace">5:15</div>
                            <div class="text-sm text-white/80 font-semibold mt-1">per km</div>
                        </div>
                        <button onclick="openTest('run')" class="w-full bg-white/20 hover:bg-white/30 text-white py-2.5 rounded-lg text-sm font-bold transition-all border border-white/10">
                            Log Run Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- PRs -->
            <div class="card rounded-xl p-5">
                <h2 class="text-base font-semibold text-surface-100 mb-4">Personal Records</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                        <div class="text-xl font-bold text-surface-100" id="pr5k">27:36</div>
                        <div class="text-xs text-surface-500 mt-0.5">5K Run</div>
                    </div>
                    <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                        <div class="text-xl font-bold text-surface-100" id="pr10k">1:00:12</div>
                        <div class="text-xs text-surface-500 mt-0.5">10K Run</div>
                    </div>
                    <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                        <div class="text-xl font-bold text-surface-400" id="prHm">‚Äî</div>
                        <div class="text-xs text-surface-500 mt-0.5">Half Marathon</div>
                    </div>
                    <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                        <div class="text-xl font-bold text-surface-100">192</div>
                        <div class="text-xs text-surface-500 mt-0.5">Max HR</div>
                    </div>
                </div>
            </div>

            <!-- Training Zones -->
            <div class="card rounded-xl p-5">
                <h2 class="text-base font-semibold text-surface-100 mb-4">Training Zones</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div>
                        <h3 class="font-medium sport-bike text-sm mb-2">üö¥ Bike Power</h3>
                        <div class="space-y-1.5 text-sm" id="bikeZones">
                            <div class="flex justify-between text-surface-400"><span>Z2 Endurance</span><span class="text-surface-200">117-159W</span></div>
                            <div class="flex justify-between text-surface-400"><span>Z3 Tempo</span><span class="text-surface-200">159-190W</span></div>
                            <div class="flex justify-between text-surface-400"><span>Z4 Threshold</span><span class="text-surface-200">190-212W</span></div>
                            <div class="flex justify-between text-surface-400"><span>Z5 VO2max</span><span class="text-surface-200">212-254W</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium sport-swim text-sm mb-2">üèä Swim Pace</h3>
                        <div class="space-y-1.5 text-sm" id="swimZones">
                            <div class="flex justify-between text-surface-400"><span>Aerobic</span><span class="text-surface-200">2:15-2:25</span></div>
                            <div class="flex justify-between text-surface-400"><span>Tempo</span><span class="text-surface-200">2:08-2:15</span></div>
                            <div class="flex justify-between text-surface-400"><span>Threshold</span><span class="text-surface-200">2:00-2:08</span></div>
                            <div class="flex justify-between text-surface-400"><span>Speed</span><span class="text-surface-200">&lt;2:00</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium sport-run text-sm mb-2">üèÉ Run Pace</h3>
                        <div class="space-y-1.5 text-sm" id="runZones">
                            <div class="flex justify-between text-surface-400"><span>Easy</span><span class="text-surface-200">5:45-6:15</span></div>
                            <div class="flex justify-between text-surface-400"><span>Marathon</span><span class="text-surface-200">5:25-5:45</span></div>
                            <div class="flex justify-between text-surface-400"><span>Threshold</span><span class="text-surface-200">5:00-5:25</span></div>
                            <div class="flex justify-between text-surface-400"><span>VO2max</span><span class="text-surface-200">&lt;5:00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test History -->
            <div class="card rounded-xl p-5">
                <h2 class="text-base font-semibold text-surface-100 mb-4">Test History</h2>
                <div class="space-y-2" id="testHistory">
                    <p class="text-surface-500 text-sm">No tests logged yet.</p>
                </div>
            </div>

            <!-- Intervals.icu Integration -->
            <div class="card rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-base font-semibold text-surface-100">Intervals.icu Integration</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-surface-500" id="intervalsStatus">Not connected</span>
                        <div class="w-2 h-2 rounded-full bg-surface-600" id="intervalsStatusDot"></div>
                    </div>
                </div>
                
                <div id="intervalsDisconnected" class="space-y-4">
                    <div class="text-sm text-surface-400">
                        Connect your intervals.icu account to sync workouts and view detailed training data.
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-surface-400 mb-1">Athlete ID</label>
                            <input type="text" id="intervalsAthleteId" placeholder="Your intervals.icu athlete ID" 
                                   class="w-full rounded-md text-sm px-3 py-2 border">
                        </div>
                        <div>
                            <label class="block text-xs text-surface-400 mb-1">API Key</label>
                            <input type="password" id="intervalsApiKey" placeholder="Your intervals.icu API key" 
                                   class="w-full rounded-md text-sm px-3 py-2 border">
                        </div>
                    </div>
                    <div class="bg-surface-800/30 rounded-lg p-3">
                        <p class="text-xs text-surface-400 mb-2">How to get your credentials:</p>
                        <ol class="text-xs text-surface-500 space-y-1 list-decimal list-inside">
                            <li>Log in to intervals.icu</li>
                            <li>Go to Settings ‚Üí API</li>
                            <li>Copy your Athlete ID and generate an API key</li>
                            <li>Enter them above and click Connect</li>
                        </ol>
                    </div>
                    <button onclick="connectIntervalsIcu()" 
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-md text-sm font-medium transition">
                        Connect to intervals.icu
                    </button>
                </div>

                <div id="intervalsConnected" class="hidden space-y-4">
                    <div id="intervalsAthleteInfo" class="bg-surface-800/30 rounded-lg p-4">
                        <!-- Athlete info will be populated here -->
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                            <div class="text-xl font-bold text-surface-100" id="intervalsWorkoutCount">0</div>
                            <div class="text-xs text-surface-500 mt-0.5">Workouts Synced</div>
                        </div>
                        <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                            <div class="text-lg font-bold text-surface-100" id="intervalsLastSync">Never</div>
                            <div class="text-xs text-surface-500 mt-0.5">Last Sync</div>
                        </div>
                        <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                            <div class="text-sm font-bold text-surface-100" id="intervalsSyncStatus">Connected</div>
                            <div class="text-xs text-surface-500 mt-0.5">Status</div>
                        </div>
                        <div class="text-center p-3 bg-surface-800/30 rounded-lg">
                            <button onclick="openCalendar()" class="w-full bg-surface-700 hover:bg-surface-600 text-surface-100 py-1.5 rounded text-xs font-medium transition">
                                View Calendar
                            </button>
                            <div class="text-xs text-surface-500 mt-0.5">Actions</div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                         <button onclick="syncIntervalsWorkouts()" 
                                 class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-md text-sm font-medium transition">
                             Sync Workouts
                         </button>
                         <button onclick="openIntervalsSettings()" 
                                 class="flex-1 bg-surface-700 hover:bg-surface-600 text-surface-100 py-2 rounded-md text-sm font-medium transition">
                             Settings
                         </button>
                         <button onclick="clearAllIntervalsWorkouts()" 
                                 class="px-4 py-2 rounded-md text-sm font-medium border border-red-500/30 text-red-500/70 hover:bg-red-500/10 transition"
                                 title="Delete all cached workouts">
                             Clear All
                         </button>
                         <button onclick="disconnectIntervalsIcu()" 
                                 class="px-4 py-2 rounded-md text-sm font-medium border border-red-500/30 text-red-500/70 hover:bg-red-500/10 transition">
                             Disconnect
                         </button>
                     </div>
                </div>
            </div>

            <!-- Athlete Info -->
            <div class="card rounded-xl p-5">
                <h2 class="text-base font-semibold text-surface-100 mb-4">Athlete Info</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-xs text-surface-400 mb-1">Weight (kg)</label>
                        <input type="number" id="weight" value="75" step="0.1" class="w-full rounded-md text-sm px-3 py-2 border">
                    </div>
                    <div>
                        <label class="block text-xs text-surface-400 mb-1">Age</label>
                        <input type="number" id="age" value="28" class="w-full rounded-md text-sm px-3 py-2 border">
                    </div>
                    <div>
                        <label class="block text-xs text-surface-400 mb-1">Max HR</label>
                        <input type="number" id="maxHr" value="192" class="w-full rounded-md text-sm px-3 py-2 border">
                    </div>
                    <div class="flex items-end">
                        <button onclick="saveProfile()" class="w-full bg-surface-700 hover:bg-surface-600 text-surface-100 py-2 rounded-md text-sm font-medium transition">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Nav -->
        <nav class="sm:hidden fixed bottom-0 inset-x-0 nav-glass border-t border-surface-800 z-50">
            <div class="flex justify-around py-2 px-4">
                <a href="/" class="flex flex-col items-center gap-0.5 px-4 py-1.5 text-surface-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <span class="text-xs font-medium">Plan</span>
                </a>
                <a href="/profile" class="flex flex-col items-center gap-0.5 px-4 py-1.5 text-surface-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    <span class="text-xs font-medium">Profile</span>
                </a>
                <a href="/calendar" class="flex flex-col items-center gap-0.5 px-4 py-1.5 text-surface-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    <span class="text-xs font-medium">Calendar</span>
                </a>
                <a href="/stats" class="flex flex-col items-center gap-0.5 px-4 py-1.5 text-surface-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span class="text-xs font-medium">Stats</span>
                </a>
            </div>
        </nav>

        <!-- Test Modal -->
        <div id="testModal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-surface-950/90 backdrop-blur-sm" onclick="closeTest()"></div>
            <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md">
                <div class="h-full sm:h-auto card rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-full border-surface-700">
                    <div class="flex items-center justify-between p-4 border-b border-surface-800">
                        <h3 class="text-base font-semibold text-surface-100" id="testModalTitle">Log Test</h3>
                        <button onclick="closeTest()" class="w-7 h-7 rounded-md hover:bg-surface-800 flex items-center justify-center text-surface-400 hover:text-surface-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4" id="testModalContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let metrics = null;
        let intervalsConfig = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            await loadHistory();
            await loadIntervalsConfig();
        });

        async function loadProfile() {
            try {
                const res = await fetch('/api/profile');
                if (res.ok) {
                    const data = await res.json();
                    metrics = data.metrics;
                    updateDisplay();
                    if (data.profile) {
                        document.getElementById('weight').value = data.profile.weight_kg || 75;
                        document.getElementById('age').value = data.profile.age || 28;
                        document.getElementById('maxHr').value = data.profile.max_hr || 192;
                    }
                }
            } catch (e) {
                metrics = { ftp_watts: 212, css_seconds_per_100m: 125, threshold_pace_per_km_seconds: 315 };
                updateDisplay();
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/testing-history');
                if (res.ok) {
                    const data = await res.json();
                    renderHistory(data);
                }
            } catch (e) {}
        }

        function updateDisplay() {
             if (!metrics) return;
             const fmt = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
             
             const ftp = metrics.ftp_watts || 212;
             const weight = metrics.ftp_weight_kg || 75;
             
             document.getElementById('ftpValue').textContent = `${ftp}W`;
             document.getElementById('ftpWkg').textContent = `${(ftp / weight).toFixed(2)} W/kg`;
             document.getElementById('cssValue').textContent = fmt(metrics.css_seconds_per_100m || 125);
             document.getElementById('thresholdPace').textContent = fmt(metrics.threshold_pace_per_km_seconds || 315);
            
            if (metrics.run_5k_seconds) document.getElementById('pr5k').textContent = fmt(metrics.run_5k_seconds);
            if (metrics.run_10k_seconds) {
                const s = metrics.run_10k_seconds;
                document.getElementById('pr10k').textContent = `${Math.floor(s/3600)}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            }
            
            updateZones();
        }

        function updateZones() {
            const ftp = metrics?.ftp_watts || 212;
            const css = metrics?.css_seconds_per_100m || 125;
            const tp = metrics?.threshold_pace_per_km_seconds || 315;
            const fmt = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
            
            document.getElementById('bikeZones').innerHTML = [
                ['Z2 Endurance', `${Math.round(ftp*0.55)}-${Math.round(ftp*0.75)}W`],
                ['Z3 Tempo', `${Math.round(ftp*0.75)}-${Math.round(ftp*0.90)}W`],
                ['Z4 Threshold', `${Math.round(ftp*0.90)}-${ftp}W`],
                ['Z5 VO2max', `${ftp}-${Math.round(ftp*1.20)}W`]
            ].map(([n,v]) => `<div class="flex justify-between text-surface-400"><span>${n}</span><span class="text-surface-200">${v}</span></div>`).join('');
            
            document.getElementById('swimZones').innerHTML = [
                ['Aerobic', `${fmt(Math.round(css*1.08))}-${fmt(Math.round(css*1.15))}`],
                ['Tempo', `${fmt(Math.round(css*1.02))}-${fmt(Math.round(css*1.08))}`],
                ['Threshold', `${fmt(Math.round(css*0.96))}-${fmt(css)}`],
                ['Speed', `<${fmt(Math.round(css*0.96))}`]
            ].map(([n,v]) => `<div class="flex justify-between text-surface-400"><span>${n}</span><span class="text-surface-200">${v}</span></div>`).join('');
            
            document.getElementById('runZones').innerHTML = [
                ['Easy', `${fmt(Math.round(tp*1.10))}-${fmt(Math.round(tp*1.20))}`],
                ['Marathon', `${fmt(Math.round(tp*1.03))}-${fmt(Math.round(tp*1.10))}`],
                ['Threshold', `${fmt(Math.round(tp*0.95))}-${fmt(Math.round(tp*1.03))}`],
                ['VO2max', `<${fmt(Math.round(tp*0.95))}`]
            ].map(([n,v]) => `<div class="flex justify-between text-surface-400"><span>${n}</span><span class="text-surface-200">${v}</span></div>`).join('');
        }

        function renderHistory(data) {
            const el = document.getElementById('testHistory');
            if (!data.length) return;
            const icons = { ftp: 'üö¥', css: 'üèä', run_5k: 'üèÉ', run_10k: 'üèÉ' };
            const names = { ftp: 'FTP', css: 'CSS', run_5k: '5K', run_10k: '10K' };
            el.innerHTML = data.slice(0, 8).map(t => `
                <div class="flex items-center justify-between p-3 bg-surface-800/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-lg">${icons[t.test_type] || 'üìä'}</span>
                        <div>
                            <div class="font-medium text-sm text-surface-100">${names[t.test_type] || t.test_type}</div>
                            <div class="text-xs text-surface-500">${new Date(t.test_date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="text-right font-semibold text-surface-100">${t.value}${t.unit}</div>
                </div>
            `).join('');
        }

        function openTest(type) {
             const modal = document.getElementById('testModal');
             const title = document.getElementById('testModalTitle');
             const content = document.getElementById('testModalContent');
             
             // Preload weight from current athlete profile
             const currentWeight = document.getElementById('weight').value || 75;
            
            const forms = {
                ftp: {
                    title: 'Log FTP Test',
                    html: `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-surface-400 mb-1">Test Type</label>
                                <select id="tFtpType" class="w-full rounded-md text-sm px-3 py-2 border" onchange="updateFtpLabel()">
                                    <option value="ramp">Ramp Test (direct FTP value)</option>
                                    <option value="20min">20-Min Test (FTP = power √ó 0.95)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-surface-400 mb-1" id="tFtpLabel">FTP (W)</label>
                                <input type="number" id="tFtpPower" class="w-full rounded-md text-sm px-3 py-2 border" placeholder="e.g. 212">
                                <p class="text-xs text-surface-500 mt-1" id="tFtpHint">Direct FTP from MyWhoosh or power meter</p>
                            </div>
                            <div>
                                <label class="block text-xs text-surface-400 mb-1">Weight (kg)</label>
                                <input type="number" id="tFtpWeight" step="0.1" class="w-full rounded-md text-sm px-3 py-2 border" value="${currentWeight}">
                            </div>
                            <div>
                                <label class="block text-xs text-surface-400 mb-1">Date</label>
                                <input type="date" id="tDate" class="w-full rounded-md text-sm px-3 py-2 border" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <button onclick="saveFtp()" class="w-full bg-sport-bike hover:opacity-80 text-white py-2.5 rounded-md font-medium">Save FTP Test</button>
                        </div>
                    `
                },
                css: {
                    title: 'Log CSS Test',
                    html: `
                        <div class="space-y-4">
                            <p class="text-sm text-surface-400">Enter 400m and 200m TT times. CSS = (400m - 200m) / 2</p>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-surface-400 mb-1">400m (mm:ss)</label>
                                    <input type="text" id="t400" class="w-full rounded-md text-sm px-3 py-2 border" placeholder="6:40">
                                </div>
                                <div>
                                    <label class="block text-xs text-surface-400 mb-1">200m (mm:ss)</label>
                                    <input type="text" id="t200" class="w-full rounded-md text-sm px-3 py-2 border" placeholder="3:10">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-surface-400 mb-1">Date</label>
                                <input type="date" id="tDate" class="w-full rounded-md text-sm px-3 py-2 border" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <button onclick="saveCss()" class="w-full bg-sport-swim hover:opacity-80 text-white py-2.5 rounded-md font-medium">Save CSS</button>
                        </div>
                    `
                },
                run: {
                    title: 'Log Run Test',
                    html: `
                        <div class="space-y-4">
                            <p class="text-sm text-surface-400">Log a 5K or 10K time trial to update training paces.</p>
                            <div>
                                <label class="block text-xs text-surface-400 mb-1">Distance</label>
                                <select id="tRunDist" class="w-full rounded-md text-sm px-3 py-2 border">
                                    <option value="5k">5K</option>
                                    <option value="10k">10K</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-surface-400 mb-1">Time (mm:ss or h:mm:ss)</label>
                                <input type="text" id="tRunTime" class="w-full rounded-md text-sm px-3 py-2 border" placeholder="27:36 or 1:00:12">
                            </div>
                            <div>
                                <label class="block text-xs text-surface-400 mb-1">Date</label>
                                <input type="date" id="tDate" class="w-full rounded-md text-sm px-3 py-2 border" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <button onclick="saveRun()" class="w-full bg-sport-run hover:opacity-80 text-white py-2.5 rounded-md font-medium">Save Run Test</button>
                        </div>
                    `
                }
            };
            
            const f = forms[type];
            title.textContent = f.title;
            content.innerHTML = f.html;
            modal.classList.remove('hidden');
        }

        function closeTest() { document.getElementById('testModal').classList.add('hidden'); }

        function parseTime(s) {
             const p = s.split(':').map(Number);
             return p.length === 2 ? p[0]*60 + p[1] : p[0]*3600 + p[1]*60 + p[2];
         }
         
         function updateFtpLabel() {
             const testType = document.getElementById('tFtpType')?.value || 'ramp';
             const label = document.getElementById('tFtpLabel');
             const hint = document.getElementById('tFtpHint');
             
             if (testType === 'ramp') {
                 label.textContent = 'FTP (W)';
                 hint.textContent = 'Direct FTP from MyWhoosh or power meter';
             } else {
                 label.textContent = '20-Minute Power (W)';
                 hint.textContent = 'Your average power over 20 minutes';
             }
         }

        async function saveFtp() {
             const testType = document.getElementById('tFtpType').value;
             const power = parseInt(document.getElementById('tFtpPower').value);
             const weight = parseFloat(document.getElementById('tFtpWeight').value);
             const date = document.getElementById('tDate').value;
             
             if (!power || !weight) return alert('Enter power and weight');
             
             // Calculate FTP based on test type
             let ftp = power;
             if (testType === '20min') {
                 ftp = Math.round(power * 0.95);
             }
             // For ramp test, use the power directly
             
             const wkg = (ftp / weight).toFixed(2);
             
             try {
                 await fetch('/api/metrics', {
                     method: 'PUT',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ 
                         ftp_watts: ftp, 
                         ftp_test_date: date, 
                         ftp_test_type: testType,
                         ftp_weight_kg: weight,
                         test_type: 'ftp', 
                         value: ftp, 
                         unit: 'W', 
                         test_date: date,
                         notes: `${testType === 'ramp' ? 'Ramp Test' : '20-Min Test'} - ${weight}kg - ${wkg} W/kg`
                     })
                 });
             } catch (e) {
                 console.error('Error saving FTP:', e);
                 alert('Error saving FTP test');
                 return;
             }
             
             await loadProfile();
             await loadHistory();
             closeTest();
             alert(`FTP: ${ftp}W (${wkg} W/kg @ ${weight}kg)`);
         }

        async function saveCss() {
            const t400 = parseTime(document.getElementById('t400').value);
            const t200 = parseTime(document.getElementById('t200').value);
            if (!t400 || !t200) return alert('Enter times');
            const css = Math.round((t400 - t200) / 2);
            const date = document.getElementById('tDate').value;
            
            try {
                await fetch('/api/metrics', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ css_seconds_per_100m: css, css_test_date: date, test_type: 'css', value: css, unit: 's', test_date: date })
                });
            } catch (e) {}
            
            await loadProfile();
            await loadHistory();
            closeTest();
            alert(`CSS: ${Math.floor(css/60)}:${(css%60).toString().padStart(2,'0')}/100m`);
        }

        async function saveRun() {
            const dist = document.getElementById('tRunDist').value;
            const secs = parseTime(document.getElementById('tRunTime').value);
            if (!secs) return alert('Enter time');
            const date = document.getElementById('tDate').value;
            
            const km = dist === '5k' ? 5 : 10;
            const pace = secs / km;
            const tp = dist === '5k' ? Math.round(pace * 1.05) : Math.round(pace);
            
            const data = {
                threshold_pace_per_km_seconds: tp,
                easy_pace_per_km_seconds: Math.round(tp * 1.15),
                test_type: `run_${dist}`,
                value: secs,
                unit: 's',
                test_date: date
            };
            if (dist === '5k') data.run_5k_seconds = secs;
            else data.run_10k_seconds = secs;
            
            try {
                await fetch('/api/metrics', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            } catch (e) {}
            
            await loadProfile();
            await loadHistory();
            closeTest();
            alert(`${dist.toUpperCase()} saved!`);
        }

        async function saveProfile() {
            try {
                await fetch('/api/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        weight_kg: parseFloat(document.getElementById('weight').value),
                        age: parseInt(document.getElementById('age').value),
                        max_hr: parseInt(document.getElementById('maxHr').value)
                    })
                });
                alert('Saved!');
            } catch (e) { alert('Error'); }
        }

        // Intervals.icu Integration Functions
        async function loadIntervalsConfig() {
            try {
                const res = await fetch('/api/intervals-icu/config');
                if (res.ok) {
                    intervalsConfig = await res.json();
                    updateIntervalsUI();
                }
            } catch (e) {
                console.error('Error loading intervals.icu config:', e);
            }
        }

        function updateIntervalsUI() {
            const disconnectedSection = document.getElementById('intervalsDisconnected');
            const connectedSection = document.getElementById('intervalsConnected');
            const statusText = document.getElementById('intervalsStatus');
            const statusDot = document.getElementById('intervalsStatusDot');

            if (intervalsConfig?.connected) {
                disconnectedSection.classList.add('hidden');
                connectedSection.classList.remove('hidden');
                statusText.textContent = 'Connected';
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500';

                // Update athlete info
                if (intervalsConfig.athleteInfo) {
                    const athleteInfo = intervalsConfig.athleteInfo;
                    document.getElementById('intervalsAthleteInfo').innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-surface-700 flex items-center justify-center text-xl">
                                ${athleteInfo.name ? athleteInfo.name.charAt(0).toUpperCase() : 'üë§'}
                            </div>
                            <div>
                                <div class="font-semibold text-surface-100">${athleteInfo.name || 'Athlete'}</div>
                                <div class="text-xs text-surface-500">ID: ${intervalsConfig.athleteId}</div>
                            </div>
                        </div>
                    `;
                }

                // Update workout count
                const workoutCount = intervalsConfig.workouts?.length || 0;
                document.getElementById('intervalsWorkoutCount').textContent = workoutCount;

                // Update last sync
                if (intervalsConfig.lastSync) {
                    const lastSync = new Date(intervalsConfig.lastSync);
                    const now = new Date();
                    const diffHours = Math.floor((now - lastSync) / (1000 * 60 * 60));
                    let syncText = diffHours === 0 ? 'Just now' :
                                   diffHours < 24 ? `${diffHours}h ago` :
                                   `${Math.floor(diffHours / 24)}d ago`;
                    document.getElementById('intervalsLastSync').textContent = syncText;
                } else {
                    document.getElementById('intervalsLastSync').textContent = 'Never';
                }

                // Update sync status
                const statusMap = {
                    'connected': 'Connected',
                    'syncing': 'Syncing...',
                    'error': 'Error'
                };
                document.getElementById('intervalsSyncStatus').textContent = statusMap[intervalsConfig.syncStatus] || 'Connected';
            } else {
                disconnectedSection.classList.remove('hidden');
                connectedSection.classList.add('hidden');
                statusText.textContent = 'Not connected';
                statusDot.className = 'w-2 h-2 rounded-full bg-surface-600';
            }
        }

        async function connectIntervalsIcu() {
            const athleteId = document.getElementById('intervalsAthleteId').value.trim();
            const apiKey = document.getElementById('intervalsApiKey').value.trim();

            if (!athleteId || !apiKey) {
                alert('Please enter both Athlete ID and API Key');
                return;
            }

            try {
                const res = await fetch('/api/intervals-icu/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ athleteId, apiKey })
                });

                const data = await res.json();

                if (res.ok) {
                    alert('Successfully connected to intervals.icu!');
                    await loadIntervalsConfig();
                    // Auto-sync workouts after connection
                    await syncIntervalsWorkouts();
                } else {
                    alert(`Connection failed: ${data.error || 'Unknown error'}`);
                }
            } catch (e) {
                console.error('Error connecting to intervals.icu:', e);
                alert('Network error. Please try again.');
            }
        }

        async function disconnectIntervalsIcu() {
            if (!confirm('Are you sure you want to disconnect from intervals.icu? Your cached workouts will be cleared.')) {
                return;
            }

            try {
                const res = await fetch('/api/intervals-icu/disconnect', {
                    method: 'POST'
                });

                if (res.ok) {
                    alert('Disconnected from intervals.icu');
                    await loadIntervalsConfig();
                } else {
                    alert('Error disconnecting');
                }
            } catch (e) {
                console.error('Error disconnecting:', e);
                alert('Network error. Please try again.');
            }
        }

         async function syncIntervalsWorkouts() {
             if (!intervalsConfig?.connected) {
                 alert('Please connect to intervals.icu first');
                 return;
             }

             const statusEl = document.getElementById('intervalsSyncStatus');
             const originalStatus = statusEl.textContent;
             statusEl.textContent = 'Syncing...';

             try {
                 const res = await fetch('/api/intervals-icu/sync', {
                     method: 'POST'
                 });

                 const data = await res.json();

                 if (res.ok) {
                     // Format message based on sync result
                     let message = `Sync complete!`;
                     if (data.added !== undefined && data.updated !== undefined) {
                         message = `Added ${data.added} new, updated ${data.updated} workouts`;
                     } else if (data.syncedWorkouts) {
                         message = `Synced ${data.syncedWorkouts} workouts`;
                     }
                     message += ` from ${data.dateRange.startDate} to ${data.dateRange.endDate}`;
                     alert(message);
                     await loadIntervalsConfig();
                 } else {
                     alert(`Sync failed: ${data.error || 'Unknown error'}`);
                     statusEl.textContent = originalStatus;
                 }
             } catch (e) {
                 console.error('Error syncing workouts:', e);
                 alert('Network error. Please try again.');
                 statusEl.textContent = originalStatus;
             }
         }

         async function clearAllIntervalsWorkouts() {
             const workoutCount = intervalsConfig?.workouts?.length || 0;
             if (workoutCount === 0) {
                 alert('No workouts to clear');
                 return;
             }

             const confirmed = confirm(
                 `Are you sure you want to delete all ${workoutCount} cached workouts? ` +
                 `This action cannot be undone. You can re-sync them from intervals.icu afterwards.`
             );

             if (!confirmed) {
                 return;
             }

             try {
                 const res = await fetch('/api/intervals-icu/clear-workouts', {
                     method: 'POST'
                 });

                 const data = await res.json();

                 if (res.ok) {
                     alert(`Cleared ${data.clearedCount} workouts`);
                     await loadIntervalsConfig();
                 } else {
                     alert(`Error: ${data.error || 'Failed to clear workouts'}`);
                 }
             } catch (e) {
                 console.error('Error clearing workouts:', e);
                 alert('Network error. Please try again.');
             }
         }

        function openCalendar() {
            window.location.href = '/calendar';
        }

        function openIntervalsSettings() {
            const settings = intervalsConfig?.syncSettings || {};
            const autoSync = settings.autoSync || false;
            const syncInterval = settings.syncInterval || 24;
            const dateRange = settings.dateRange || 30;
            const useCustomDates = settings.useCustomDates || false;
            const customStartDate = settings.customStartDate || '';
            
            const html = `
                <div class="space-y-4">
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="settingsAutoSync" ${autoSync ? 'checked' : ''} 
                                   class="w-4 h-4 rounded border-surface-600">
                            <span class="text-sm text-surface-200">Enable Auto-Sync</span>
                        </label>
                        <p class="text-xs text-surface-500 mt-1 ml-6">Automatically sync workouts in the background</p>
                    </div>
                    
                    <div>
                        <label class="block text-xs text-surface-400 mb-1">Sync Interval (hours)</label>
                        <select id="settingsSyncInterval" class="w-full rounded-md text-sm px-3 py-2 border">
                            <option value="1" ${syncInterval === 1 ? 'selected' : ''}>Every hour</option>
                            <option value="6" ${syncInterval === 6 ? 'selected' : ''}>Every 6 hours</option>
                            <option value="12" ${syncInterval === 12 ? 'selected' : ''}>Every 12 hours</option>
                            <option value="24" ${syncInterval === 24 ? 'selected' : ''}>Every 24 hours (recommended)</option>
                            <option value="48" ${syncInterval === 48 ? 'selected' : ''}>Every 48 hours</option>
                        </select>
                    </div>
                    
                    <div class="border-t border-surface-800 pt-4">
                        <label class="block text-sm font-medium text-surface-200 mb-3">Sync Date Range</label>
                        
                        <div class="space-y-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="dateRangeType" value="relative" 
                                       ${!useCustomDates ? 'checked' : ''} 
                                       onchange="toggleDateRangeType(false)"
                                       class="w-4 h-4">
                                <span class="text-sm text-surface-200">Last N days (relative)</span>
                            </label>
                            
                            <div id="relativeDateRange" class="ml-6 ${!useCustomDates ? '' : 'hidden'}">
                                <select id="settingsDateRange" class="w-full rounded-md text-sm px-3 py-2 border">
                                    <option value="7" ${dateRange === 7 ? 'selected' : ''}>Last 7 days</option>
                                    <option value="14" ${dateRange === 14 ? 'selected' : ''}>Last 14 days</option>
                                    <option value="30" ${dateRange === 30 ? 'selected' : ''}>Last 30 days (recommended)</option>
                                    <option value="60" ${dateRange === 60 ? 'selected' : ''}>Last 60 days</option>
                                    <option value="90" ${dateRange === 90 ? 'selected' : ''}>Last 90 days</option>
                                    <option value="180" ${dateRange === 180 ? 'selected' : ''}>Last 180 days (6 months)</option>
                                    <option value="365" ${dateRange === 365 ? 'selected' : ''}>Last 365 days (1 year)</option>
                                </select>
                            </div>
                            
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="dateRangeType" value="custom" 
                                       ${useCustomDates ? 'checked' : ''} 
                                       onchange="toggleDateRangeType(true)"
                                       class="w-4 h-4">
                                <span class="text-sm text-surface-200">Custom date range</span>
                            </label>
                            
                            <div id="customDateRange" class="ml-6 space-y-2 ${useCustomDates ? '' : 'hidden'}">
                                <div>
                                    <label class="block text-xs text-surface-400 mb-1">Start Date (sync from this date onwards)</label>
                                    <input type="date" id="settingsCustomStartDate" value="${customStartDate}"
                                           class="w-full rounded-md text-sm px-3 py-2 border">
                                </div>
                                <p class="text-xs text-surface-500">Workouts will be synced from this date until today</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 pt-4 border-t border-surface-800">
                        <button onclick="saveIntervalsSettings()" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-md text-sm font-medium transition">
                            Save Settings
                        </button>
                        <button onclick="closeIntervalsSettings()" class="px-4 py-2 rounded-md text-sm font-medium border border-surface-600 text-surface-300 hover:bg-surface-800 transition">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'intervalsSettingsModal';
            modal.className = 'fixed inset-0 z-50';
            modal.innerHTML = `
                <div class="absolute inset-0 bg-surface-950/90 backdrop-blur-sm" onclick="closeIntervalsSettings()"></div>
                <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md">
                    <div class="h-full sm:h-auto card rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-full border-surface-700">
                        <div class="flex items-center justify-between p-4 border-b border-surface-800">
                            <h3 class="text-base font-semibold text-surface-100">Sync Settings</h3>
                            <button onclick="closeIntervalsSettings()" class="w-8 h-8 rounded-lg hover:bg-surface-800 flex items-center justify-center transition text-surface-400 hover:text-surface-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 scrollbar-thin">
                            ${html}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeIntervalsSettings() {
            const modal = document.getElementById('intervalsSettingsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function toggleDateRangeType(useCustom) {
            const relativeDiv = document.getElementById('relativeDateRange');
            const customDiv = document.getElementById('customDateRange');
            
            if (useCustom) {
                relativeDiv.classList.add('hidden');
                customDiv.classList.remove('hidden');
            } else {
                relativeDiv.classList.remove('hidden');
                customDiv.classList.add('hidden');
            }
        }
        
        async function saveIntervalsSettings() {
            const autoSync = document.getElementById('settingsAutoSync').checked;
            const syncInterval = parseInt(document.getElementById('settingsSyncInterval').value);
            
            const useCustomDates = document.querySelector('input[name="dateRangeType"]:checked').value === 'custom';
            const dateRange = useCustomDates ? null : parseInt(document.getElementById('settingsDateRange').value);
            const customStartDate = useCustomDates ? document.getElementById('settingsCustomStartDate').value : null;
            
            if (useCustomDates && !customStartDate) {
                alert('Please select a start date for custom date range');
                return;
            }
            
            try {
                // Save sync settings
                await fetch('/api/intervals-icu/sync-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        autoSync,
                        syncInterval,
                        dateRange,
                        useCustomDates,
                        customStartDate
                    })
                });
                
                // Enable/disable auto-sync
                await fetch('/api/intervals-icu/auto-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: autoSync,
                        intervalHours: syncInterval
                    })
                });
                
                alert('Settings saved successfully!');
                await loadIntervalsConfig();
                closeIntervalsSettings();
            } catch (e) {
                console.error('Error saving settings:', e);
                alert('Error saving settings. Please try again.');
            }
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTest(); });
    </script>
</body>
</html>
